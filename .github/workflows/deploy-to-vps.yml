name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Build and Push Docker image
      run: |
        # Create a simple deploy script that will be executed on the VPS
        cat > deploy.sh << 'EOF'
#!/bin/bash
set -e
echo "Starting deployment..."
cd /home/runner/selfdezign.ro
echo "Pulling latest code..."
git pull origin main
echo "Building Docker image..."
docker build -t selfdezign-app:latest .
echo "Stopping old container..."
docker stop selfdezign-app || true
docker rm selfdezign-app || true
echo "Starting new container..."
docker run -d --name selfdezign-app -p 3000:3000 selfdezign-app:latest
echo "Deployment complete!"
EOF
        chmod +x deploy.sh
    
    - name: Deploy to VPS via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: 22
        script_stop: true
        script: |
          cd /home/runner/selfdezign.ro
          git pull origin main
          docker build -t selfdezign-app:latest .
          docker stop selfdezign-app || true
          docker rm selfdezign-app || true
          docker run -d --name selfdezign-app -p 3000:3000 selfdezign-app:latest
          echo "Deployment successful!"
    
    - name: Verify deployment
      run: |
        sleep 5
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://selfdezign.ro/)
        if [ "$STATUS" = "200" ]; then
          echo "Website is online (HTTP $STATUS)"
          exit 0
        else
          echo "Website returned HTTP $STATUS"
          exit 1
        fi
