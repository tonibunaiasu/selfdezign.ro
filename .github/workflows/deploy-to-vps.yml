name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Build Docker image
      run: |
        docker build -t selfdezign-app:latest .
        docker save selfdezign-app:latest > /tmp/selfdezign-app.tar
        ls -lh /tmp/selfdezign-app.tar
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        timeout: 600s
        command_timeout: 600s
        script: |
          set -e
          echo "Stopping old container..."
          docker stop selfdezign-app 2>/dev/null || true
          docker rm selfdezign-app 2>/dev/null || true
          docker rmi selfdezign-app 2>/dev/null || true
          mkdir -p /tmp/deploy
          echo "Deployment scripts ready"
    
    - name: Transfer Docker image
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        source: "/tmp/selfdezign-app.tar"
        target: "/tmp/deploy/"
        timeout: 600s
    
    - name: Load and run Docker image
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        password: ${{ secrets.VPS_PASSWORD }}
        port: 22
        timeout: 600s
        command_timeout: 600s
        script: |
          set -e
          echo "Loading Docker image from tar file..."
          docker load < /tmp/deploy/selfdezign-app.tar
          echo "Starting new container..."
          docker run -d --name selfdezign-app -p 3000:3000 selfdezign-app:latest
          echo "Waiting for app to start..."
          sleep 5
          echo "Deployment complete"
    
    - name: Verify deployment
      run: |
        echo "Verifying deployment..."
        sleep 5
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://selfdezign.ro/ || echo "000")
        echo "Website HTTP status: $STATUS"
        if [ "$STATUS" = "200" ] || [ "$STATUS" = "301" ] || [ "$STATUS" = "302" ]; then
          echo "Website is online"
          exit 0
        else
          echo "Website check returned: $STATUS"
          exit 1
        fi
