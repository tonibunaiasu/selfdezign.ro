name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Deploy to VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        port: 22
        timeout: 300s
        command_timeout: 300s
        script: |
          set -e
          echo "Starting deployment..."
          cd /home/runner/selfdezign.ro || mkdir -p /home/runner/selfdezign.ro
          cd /home/runner/selfdezign.ro
          echo "Current directory: $(pwd)"
          echo "Pulling latest code..."
          git pull origin main 2>/dev/null || git clone https://github.com/tonibunaiasu/selfdezign.ro.git .
          echo "Stopping old container..."
          docker stop selfdezign-app 2>/dev/null || true
          docker rm selfdezign-app 2>/dev/null || true
          echo "Building Docker image..."
          docker build -t selfdezign-app:latest .
          echo "Starting new container..."
          docker run -d --name selfdezign-app -p 3000:3000 selfdezign-app:latest
          echo "Waiting for app to start..."
          sleep 5
          echo "Deployment complete"
    
    - name: Verify deployment
      run: |
        echo "Verifying deployment..."
        sleep 5
        STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://selfdezign.ro/ || echo "000")
        echo "Website HTTP status: $STATUS"
        if [ "$STATUS" = "200" ] || [ "$STATUS" = "301" ] || [ "$STATUS" = "302" ]; then
          echo "Website is online"
          exit 0
        else
          echo "Website check returned: $STATUS"
          exit 1
        fi
