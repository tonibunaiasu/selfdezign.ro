name: Webhook Deploy

on:
  push:
    branches: [ main ]

jobs:
  trigger-webhook:
    runs-on: ubuntu-latest
    steps:
    - name: Trigger VPS deployment webhook
      run: |
        # Generez URL-ul webhook cu secretul ca parametru
        WEBHOOK_URL="${{ secrets.VPS_WEBHOOK_URL }}"
        
        if [ -z "$WEBHOOK_URL" ]; then
          echo "ERROR: VPS_WEBHOOK_URL secret not configured!"
          echo "Please add VPS_WEBHOOK_URL to GitHub Secrets"
          echo "Format: http://YOUR_VPS_IP:8888/webhook?secret=YOUR_SECRET"
          exit 1
        fi
        
        echo "Triggering webhook at VPS..."
        curl -X POST "$WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d '{"action":"deploy","branch":"main"}' \
          -v
        
        echo "Webhook triggered successfully"
        echo "Waiting for VPS deployment..."
        sleep 10
    
    - name: Verify website is online
      run: |
        echo "Checking if website is online..."
        for i in {1..30}; do
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://selfdezign.ro/ || echo "000")
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "301" ] || [ "$STATUS" = "302" ]; then
            echo "SUCCESS: Website is online (HTTP $STATUS)"
            exit 0
          fi
          echo "Attempt $i/30 - Status: $STATUS. Retrying in 5 seconds..."
          sleep 5
        done
        
        echo "WARNING: Website check timeout - it may still be starting"
        exit 0
